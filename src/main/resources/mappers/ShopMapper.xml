<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.mapper.ShopMapper">

    <!-- 查询每周店铺数据 -->
    <select id="findWeeklyShopData" resultType="com.example.model.BusShop">
        SELECT tenant_id AS tenantId, gptqty, vipgptqty, orderqty, update_time AS updateTime
        FROM bus_shop
    </select>

    <!-- 插入每周任务日志到冗余表 -->
    <insert id="insertWeeklyTaskLog">
        INSERT INTO bus_shop_weekly_task_log (tenant_id, week_number, gptqty, vipgptqty, orderqty)
        VALUES (#{tenantId}, #{weekNumber}, #{gptqty}, #{vipgptqty}, #{orderqty})
    </insert>

    <!-- 查询每周任务记录 -->
    <select id="findWeeklyTaskLog" resultType="com.example.model.BusShopWeeklyTaskLog">
        SELECT tenant_id AS tenantId, gptqty, vipgptqty, orderqty
        FROM bus_shop_weekly_task_log
        WHERE tenant_id = #{tenantId} AND week_number = #{weekNumber}
    </select>

    <!-- 检查每周任务记录是否存在 -->
    <select id="checkWeeklyTaskLogExists" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM bus_shop_weekly_task_log
        WHERE tenant_id = #{tenantId} AND week_number = #{weekNumber}
    </select>

    <!-- 更新任务日志 -->
    <update id="updateTaskLog">
        UPDATE bus_shop_weekly_task_log
        SET gptqty = #{gptqty}, vipgptqty = #{vipgptqty}, orderqty = #{orderqty}
        WHERE tenant_id = #{tenantId} AND week_number = #{weekNumber}
    </update>

</mapper>
